{{ if eq .osid "darwin" -}}

#!{{ lookPath "bash" }}

brew update
brew bundle --file=/dev/stdin <<EOF
{{ range (.packages.darwin.brews | sortAlpha | uniq) -}}
brew "{{ . }}"
{{ end -}}
{{ if not .headless -}}
{{ range (.packages.darwin.casks | sortAlpha | uniq) -}}
cask "{{ . }}"
{{ end -}}
{{ end -}}
EOF

{{ range .packages.darwin.services }}
if [[ $(brew services info {{ . }} --json | jq -r '.[0].registered') == "false" ]]; then
  sudo brew services start {{ . }}
fi
{{ end -}}

{{ range $name, $id := .packages.darwin.mas }}
echo "Installing {{ $name }} from Mac App Store..."
mas install {{ $id }}
{{ end }}
{{ end -}}
